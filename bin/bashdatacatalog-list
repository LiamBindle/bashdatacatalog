#!/usr/bin/env bash

while getopts "anstr:p:mwuf:c:" FLAG; do
    case "${FLAG}" in
        a)
            export BDC_LIST_STATIC=true
            export BDC_LIST_TEMPORAL=true
            ;;
        n)
            export BDC_LIST_NEW=true
            ;;
        s)
            export BDC_LIST_STATIC=true
            ;;
        t)
            export BDC_LIST_TEMPORAL=true
            ;;
        r)
            export BDC_LIST_RANGE=${OPTARG}
            ;;
        p)
            export BDC_LIST_PATTERN=${OPTARG}
            ;;
        m)
            export BDC_LIST_KEEP="missing"
            ;;
        w)
            export BDC_LIST_KEEP="wrong"
            ;;
        u)
            export BDC_LIST_KEEP="unnecessary"
            ;;
        f)
            export BDC_LIST_FORMAT=${OPTARG}
            ;;
    esac 
done
shift $(($OPTIND-1))

# Parse catalogs
combined_catalog=$(mktemp)
if [ $# -eq 0 ]; then
    # cwd is the collection
    bdcat-combine ./ > ${combined_catalog}
else
    bdcat-combine $@ > ${combined_catalog}
fi

while read COLLECTION_LINE; do
    export BDC_COLLECTION_PREFIX=$(echo "$COLLECTION_LINE" | awk -F',' '{print $1}' | sed 's#/*$#/#g')
    export BDC_COLLECTION_URL=$(echo "$COLLECTION_LINE" | awk -F',' '{print $2}' | sed 's#/*$#/#g')
    mkdir -p $BDC_COLLECTION_PREFIX

    (
        cd $BDC_COLLECTION_PREFIX
        bdcat-ls
    )
done < ${combined_catalog}


rm ${combined_catalog}